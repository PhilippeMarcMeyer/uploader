/*! uploader v0.1.0 | (c) 2014 Fengyuan Chen */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){"use strict";function b(b,c){this.id="uploader-"+(new Date).valueOf().toString()+Math.random().toString().replace(".",""),this.$fileInput=a(b),this.init(c)}b.defaults={autoUpload:!0,url:void 0,dataType:"json",data:{},name:void 0,multiple:!1,singleUploads:!0,maxLength:void 0,maxSize:void 0,messages:{input:"The current borwser doesn't support file input.",type:'The type of the input element must be "file".',length:"The number of selected files is exceeded the limit of <%= length %>.",size:'The size of file "<%= name %>" is exceeded the limit of <%= size %>.',unselected:"Please select files.",success:"Upload Done.",error:"Upload Error."},beforeUpload:function(a){console.log(a)},success:function(){console.log(this.messages.success)},error:function(a){console.log(a||this.messages.error)}},b.prototype={constructor:b,support:{fileInput:!a('<input type="file">').prop("disabled"),fileList:!!a('<input type="file">').prop("files"),fileReader:!!window.FileReader,formData:!!window.FormData},init:function(c){var d=this.$fileInput.data(),e=this.$fileInput.attr("name"),f=this.$fileInput.attr("type");if(console.log(this),!this.support.fileInput)throw new Error(this.defaults.messages.input);if("file"!==f)throw new Error(this.defaults.messages.type);e&&!d.name&&(d.name=e),d.multiple=this.$fileInput.prop("multipple"),this.defaults=a.extend({},b.defaults,d,c),this.support.formData?this.xhrUpload=!0:(this.xhrUpload=!1,this.initUploader()),this.enable()},enabled:!1,enable:function(){var b=this;this.enabled||(this.enabled=!0,this.xhrUpload?this.$trigger=this.$fileInput:(this.$trigger=this.$fileInputClone,this.$fileInput.on("click",function(a){return a.preventDefault(),a.stopPropagation(),b.$fileInputClone.trigger("click"),!1}),this.$fileInput.on("keydown",function(a){return a.preventDefault(),a.stopPropagation(),13===a.keyCode&&b.$fileInputClone.trigger("click"),!1})),this.$trigger.on("change",a.proxy(this.serialize,this)))},disabled:!0,disable:function(){this.disabled||(this.disabled=!0,this.xhrUpload||(this.$fileInput.off("click"),this.$fileInput.off("keyup"),this.$iframe.off("load"),this.$uploader.empty().remove()),this.$trigger.off("change"))},serialize:function(){var a,b,c,d;if(this.i=0,this.length=0,this.files={},this.support.fileList){for(a=this.$trigger.prop("files"),b=this.checkLength(a.length),d=0;b>d;d++)c=a[d],this.isValidFile(c)&&(this.files[this.i++]=c,this.read(c));this.length=this.i,0===this.length&&this.$trigger.val("")}else this.length=1,this.defaults.beforeUpload({});this.defaults.autoUpload&&this.start()},read:function(a){var c=this,d=null,e={name:a.name,type:a.type,extension:a.name.match(/([^\.]\w+)$/)[1],size:b.fn.formatSize(a.size)};this.support.fileReader?(d=new FileReader,d.readAsDataURL(a),d.onload=function(){e.url=this.result},d.onloadend=function(){c.defaults.beforeUpload(e)}):this.defaults.beforeUpload(e)},checkLength:function(a){var b=this.defaults.maxLength;return b&&a>b&&(a=b,this.defaults.error(this.defaults.messages.length.replace("<%= length %>",a))),a},isValidFile:function(a){var c=b.fn.parseSize(this.defaults.maxSize),d=b.fn.formatSize(c);return c>0&&c<a.size?(this.defaults.error(this.defaults.messages.size.replace("<%= name %>",a.name).replace("<%= size %>",d)),!1):!0},start:function(){return this.length&&0!==this.length?(console.log("Start:"),console.log(this),this.$fileInput.prop("disabled",!0),this.i=0,this.upload(),void 0):(this.defaults.error(this.defaults.messages.unselected),void 0)},next:function(){console.log("Next:"),console.log(this),this.i++,this.i<this.length?this.upload():this.stop()},stop:function(){console.log("Stop:"),console.log(this),this.$fileInput.prop("disabled",!1),this.$trigger.val(""),this.length=0,this.files=null},upload:function(){var b={},c=this;return this.xhrUpload?(this.support.fileList?(b=new FormData,a.each(this.defaults.data,function(a,c){b.append(a,c)}),b.append(this.defaults.name,this.files[this.i])):b=new FormData(this.$uploader.find("form")[0]),a.ajax({type:"post",url:this.defaults.url,data:b,dataType:this.defaults.dataType,processData:!1,contentType:!1,success:function(a,b){console.log("File "+c.i+" status:"+b),console.log("File "+c.i+" url:"+a.result),c.defaults.success(a),c.next()},error:function(a,b,d){console.log("File "+c.i+" status:"+b+d),c.defaults.error(),c.next()}}),void 0):(this.$button.click(),void 0)},initUploader:function(){var c=['<div id="'+this.id+'" stype="display:8none;">','<form method="post" action="'+this.defaults.url+'" enctype="multipart/form-data" target="uploader-iframe">',"<div>"+b.fn.template(this.defaults.data)+"</div>",'<button type="submit">Upload</button>','<input type="file" name="'+this.defaults.name+'"'+(this.defaults.multiple?" multiplle":"")+">","</form>",'<iframe name="uploader-iframe"></iframe>',"</div>"].join(""),d=a(c),e=this;d.appendTo("body"),this.$uploader=d,this.$fileInputClone=d.find("input[type='file']"),this.$button=d.find("button"),this.$iframe=d.find("iframe"),this.$iframe.on("load",function(){var b,c=this.contentWindow,d=this.contentDocument;d=d?d:c.document,b=d?d.body.innerText:null,b?(b="string"==typeof b?a.parseJSON(b):b,e.defaults.success(b)):e.defaults.error(),e.stop()})}},b.fn={SIZE_NUMBER_KB:1024,SIZE_NUMBER_MB:Math.pow(1024,2),SIZE_NUMBER_GB:Math.pow(1024,3),template:function(b){var c=[];return a.each(b,function(a,b){c.push('<input type="hidden" name="'+a+'" value="'+b+'">')}),c.join("")},parseSize:function(a){var b;if("string"==typeof a)switch(b=a.match(/(\d*)(\w*)/),a=parseInt(b[1],10)||0,console.log(b[1]),console.log(b[2]),b[2].toUpperCase()){case"K":case"KB":a*=this.SIZE_NUMBER_KB;break;case"M":case"MB":a*=this.SIZE_NUMBER_MB;break;case"G":case"GB":a*=this.SIZE_NUMBER_GB}return"number"==typeof a?a:-1},formatSize:function(a){return a=parseInt(a,10)||0,a>this.SIZE_NUMBER_GB?Math.floor(a/this.SIZE_NUMBER_GB)+"GB":a>this.SIZE_NUMBER_MB?Math.floor(a/this.SIZE_NUMBER_MB)+"MB":a>this.SIZE_NUMBER_KB?Math.floor(a/this.SIZE_NUMBER_KB)+"KB":a+"B"}},a.fn.uploader=function(c){return this.each(function(){a(this).data("uploader",new b(this,c))})},a.fn.uploader.Constructor=b,a(function(){a("*[data-uploader]").uploader()})});